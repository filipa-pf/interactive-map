<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mapa Interativo de Portugal</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body {
  height: 100%;
  margin: 0;
}

.container {
  display: flex;
  gap: 20px;
  padding: 10px;
  flex-wrap: wrap; /* permite quebra de linha se necessário */
}

#map {
  flex: 2 1 300px; /* grow, shrink, base */
  min-width: 300px;
  height: 600px; /* altura desktop */
}

.info {
  flex: 1 1 250px;
  min-width: 250px;
  padding: 20px;
  background: #f8f8f8;
  overflow-y: auto;
}

.concelho {
  cursor: pointer;
}

/* MOBILE */
@media (max-width: 768px) {
  .container { flex-direction: column !important; }
  #map, .info { width: 100% !important; flex: none !important; }
  #map { height: 300px !important; }
  .info { height: auto !important; }
}
</style>

</head>
<body>

<div class="container">
  <div id="map"></div>
  <div class="info">
    <h2>Info do concelho</h2>
    <div id="infoContent">
      Clique num concelho para gerar um PDF com o nome do concelho.
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

// Inicializar mapa
const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([39.5, -8], 7);

// Cores por distrito
const coresDistritos = {
  "Braga": "#f94144",
  "Porto": "#f3722c",
  "Viana do Castelo": "#f8961e",
  "Vila Real": "#f9c74f",
  "Aveiro": "#90be6d",
  "Coimbra": "#43aa8b",
  "Leiria": "#577590",
  "Lisboa": "#277da1",
  "Setúbal": "#9d4edd",
  "Évora": "#f72585",
  "Beja": "#7209b7",
  "Faro": "#3a0ca3",
  "Castelo Branco": "#4361ee",
  "Guarda": "#4cc9f0",
  "Açores": "#00b894"
};

// Função para escurecer cor
function escurecerCor(cor, fator = 0.7) {
  const rgb = cor.match(/\w\w/g).map(x => parseInt(x, 16));
  const escuro = rgb.map(v => Math.floor(v * fator));
  return `rgb(${escuro.join(",")})`;
}

// Buscar concelhos da API Opendatasoft
async function loadConcelhos() {
  try {
    const res = await fetch('https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-portugal-concelho/exports/json');
    const data = await res.json();

    const geojsonData = data.map(d => {
      const feature = d.geo_shape;
      feature.properties = {
        con_name: d.con_name,
        dis_name: d.dis_name
      };
      return feature;
    });

    const geojsonLayer = L.geoJSON(geojsonData, {
      style: feature => {
        const distrito = feature.properties.dis_name || '';
        return { 
          color: '#000', 
          weight: 1, 
          fillOpacity: 0.6,
          fillColor: coresDistritos[distrito] || '#ccc'
        };
      },
      onEachFeature: (feature, layer) => {
        const nome = feature.properties.con_name || 'Sem nome';
        const distrito = feature.properties.dis_name || 'Sem distrito';
        const corOriginal = coresDistritos[distrito] || '#ccc';

        // Hover
        layer.on('mouseover', () => layer.setStyle({ fillColor: escurecerCor(corOriginal) }));
        layer.on('mouseout', () => layer.setStyle({ fillColor: corOriginal }));

        // Click
        layer.on('click', () => {
          document.getElementById('infoContent').innerHTML = `
            <strong>${nome}</strong><br>
            Distrito: ${distrito}<br>
            <button id="pdfBtn">Gerar PDF</button>
          `;

          document.getElementById('pdfBtn').onclick = () => {
            const doc = new jsPDF();
            doc.text(`Concelho: ${nome}\nDistrito: ${distrito}`, 10, 10);
            doc.save(`${nome}.pdf`);
          };
        });
      }
    }).addTo(map);

    // Ajustar mapa para caber no container
    const bounds = geojsonLayer.getBounds();
    if (bounds.isValid && bounds.isValid()) {
      map.fitBounds(bounds, { padding: [20, 20] });
    }

  } catch(err) {
    console.error('Erro ao carregar concelhos:', err);
  }
}

loadConcelhos();
</script>
</body>
</html>
