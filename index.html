<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mapa Interativo de Portugal</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
  margin: 0;
  font-family: sans-serif;
}

.container {
  display: flex;
  flex-wrap: wrap; /* Permite que elementos quebrem linha */
}

/* Mapa e sidebar lado a lado em telas grandes */
#map {
  flex: 2;
  min-width: 300px;
  height: 650px;
}

.info {
  flex: 1;
  min-width: 250px;
  padding: 20px;
  box-sizing: border-box;
}

/* Mobile: mapa em cima, info embaixo */
@media (max-width: 768px) {
  #map, .info {
    flex: 1 1 100%; /* ambos ocupam 100% da largura */
    height: 400px;   /* altura menor para mobile */
  }
  .info {
    padding: 10px;
  }
}

@media (max-width: 480px) {
  #map {
    height: 300px; /* ainda mais compacto */
  }
  .info {
    padding: 5px;
    font-size: 14px;
  }
}
</style>

</head>
<body>

<div class="container">
  <div id="map"></div>
  <div class="info">
    <h2>Info do concelho</h2>
    <div id="infoContent">
      Clique num concelho para gerar um PDF com o nome do concelho.
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

// Inicializar mapa
const map = L.map('map', { zoomControl: true, attributionControl: false })
  .setView([39.5, -8], 7);

// Função para buscar info extra via API
async function fetchConcelhoInfo(codigo) {
  const url = `https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-portugal-concelho/records/?filter[codigo]=${codigo}`;
  const res = await fetch(url);
  const data = await res.json();
  if(data.records && data.records.length > 0){
    return data.records[0].record.fields;
  }
  return null;
}

// Carregar GeoJSON
fetch('concelhos.json')
  .then(res => res.json())
  .then(async geoData => {

    for(const geom of geoData.geometries){
      // Aqui definimos um "código" fictício, se tiveres um campo real no JSON, substitui
      const codigo = geom.properties?.codigo || Math.floor(Math.random()*10000);

      const feature = {
        type: "Feature",
        properties: { codigo: codigo, name: `Concelho ${codigo}` },
        geometry: geom
      };

      L.geoJSON(feature, {
        style: () => ({
          color: '#556',
          weight: 1,
          fillColor: '#ccc',
          fillOpacity: 0.6
        }),
        onEachFeature: (feature, layer) => {
          layer.on('click', async () => {
            const info = await fetchConcelhoInfo(feature.properties.codigo);
            if(info){
              const content = `
                <strong>Nome Concelho:</strong> ${info.nome}<br>
                <strong>Distrito:</strong> ${info.distrito}<br>
                <strong>Código:</strong> ${info.codigo}<br>
                <strong>Ano:</strong> ${info.ano}<br>
                <strong>Tipo:</strong> ${info.tipo}
              `;
              document.getElementById('infoContent').innerHTML = content;

              const doc = new jsPDF();
              doc.setFontSize(22);
              doc.text(`Documento do concelho de ${info.nome}`, 20, 30);
              doc.setFontSize(14);
              doc.text(`Distrito: ${info.distrito}`, 20, 50);
              doc.text(`Código: ${info.codigo}`, 20, 60);
              doc.text(`Ano: ${info.ano}`, 20, 70);
              doc.text(`Tipo: ${info.tipo}`, 20, 80);
              doc.save(`Concelho_${info.nome}.pdf`);
            } else {
              alert('Info não encontrada para este concelho.');
            }
          });

          layer.on('mouseover', () => layer.setStyle({ fillColor: '#faa', weight: 2 }));
          layer.on('mouseout', () => layer.setStyle({ fillColor: '#ccc', weight: 1 }));
        }
      }).addTo(map);
    }

  })
  .catch(err => console.error('Erro:', err));
</script>
</body>
</html>
