<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Mapa Interativo de Portugal (com ilhas próximas)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    .container { display: flex; flex-wrap: wrap; padding: 10px; gap: 20px; height: 100vh; }
    #map { flex: 2 1 300px; min-width: 300px; height: 100%; position: relative; background: white; }
    .info { flex: 1 1 250px; min-width: 250px; padding: 20px; background: #f8f8f8; overflow-y: auto; }
    .concelho { cursor: pointer; }
    @media (max-width: 768px) {
      .container { flex-direction: column; }
      #map { height: 300px; }
    }
  </style>
</head>
<body>

<div class="container">
  <div id="map"></div>
  <div class="info">
    <h2>Info do concelho</h2>
    <div id="infoContent">
      Clique num concelho para gerar um PDF com o nome do concelho.
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

// Inicializa o mapa (sem tiles)
const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([39.5, -8], 7);

// Cores definidas para todos os distritos e regiões autónomas
const coresDistritos = {
  "Aveiro": "#e6194B",
  "Beja": "#3cb44b",
  "Braga": "#ffe119",
  "Bragança": "#4363d8",
  "Castelo Branco": "#f58231",
  "Coimbra": "#911eb4",
  "Évora": "#46f0f0",
  "Faro": "#f032e6",
  "Guarda": "#bcf60c",
  "Leiria": "#fabebe",
  "Lisboa": "#008080",
  "Portalegre": "#e6beff",
  "Porto": "#9A6324",
  "Santarém": "#fffac8",
  "Setúbal": "#800000",
  "Viana do Castelo": "#aaffc3",
  "Vila Real": "#808000",
  "Viseu": "#ffd8b1",
  "Açores": "#000075",
  "Madeira": "#e6194B"
};

// Hover: escurece a cor original
function escurecerCor(cor, fator = 0.7) {
  const rgb = cor.match(/\w\w/g).map(x => parseInt(x, 16));
  return `rgb(${rgb.map(v => Math.floor(v * fator)).join(',')})`;
}

// Função para deslocar Açores e Madeira para junto do continente
function deslocarIlhas(feature) {
  const distrito = feature.properties.dis_name;
  if (!feature.geometry) return feature;

  const deslocar = (coords, offset) => {
    if (typeof coords[0][0] === 'number') {
      // Polígono simples
      return coords.map(c => [c[0] + offset[0], c[1] + offset[1]]);
    }
    // MultiPolygon
    return coords.map(p => deslocar(p, offset));
  };

if (distrito === 'Madeira') feature.geometry.coordinates = deslocar(feature.geometry.coordinates, [5, -6.5]);
if (distrito === 'Açores') feature.geometry.coordinates = deslocar(feature.geometry.coordinates, [5, -5]);
  }
  return feature;
}

// Carregamento dos concelhos
async function loadConcelhos() {
  try {
    const res = await fetch('https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-portugal-concelho/exports/json');
    const data = await res.json();

    const geojsonData = data.map(d => {
      const feature = d.geo_shape;
      feature.properties = { con_name: d.con_name, dis_name: d.dis_name };
      return deslocarIlhas(feature);
    });

    const geojsonLayer = L.geoJSON(geojsonData, {
      style: feature => {
        const district = feature.properties.dis_name;
        return {
          color: '#000',
          weight: 1,
          fillOpacity: 0.6,
          fillColor: coresDistritos[district] || '#ccc'
        };
      },
      onEachFeature: (feature, layer) => {
        const { con_name, dis_name } = feature.properties;
        const cor = coresDistritos[dis_name] || '#ccc';
        layer.on('mouseover', () => layer.setStyle({ fillColor: escurecerCor(cor) }));
        layer.on('mouseout', () => layer.setStyle({ fillColor: cor }));
        layer.on('click', () => {
          document.getElementById('infoContent').innerHTML = 
            `<strong>${con_name}</strong><br>Distrito: ${dis_name}<br><button id="pdfBtn">Gerar PDF</button>`;
          document.getElementById('pdfBtn').onclick = () => {
            const doc = new jsPDF();
            doc.text(`Concelho: ${con_name}\nDistrito: ${dis_name}`, 10, 10);
            doc.save(`${con_name}.pdf`);
          };
        });
      }
    }).addTo(map);

map.setView([39.5, -8], 8); // centraliza no continente com zoom maior

window.addEventListener('resize', () => {
  map.setView([39.5, -8], 8);
});
  } catch (err) {
    console.error('Erro ao carregar concelhos:', err);
  }
}

loadConcelhos();
</script>

</body>
</html>
