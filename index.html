<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mapa Interativo de Portugal</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
/* Container que envolve mapa e info */
.container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 10px;
  box-sizing: border-box;
}

/* Mapa */
#map {
  flex: 2;
  min-width: 300px;
  height: 630px;
  box-sizing: border-box;
}

/* Info lateral */
.info {
  flex: 1;
  min-width: 250px;
  padding: 20px;
  box-sizing: border-box;
}

/* Efeito hover nas concelhos */
.concelho:hover {
  fill: #faa !important;
  cursor: pointer;
}

/* Mobile: reduzir altura do mapa se necessário */
@media (max-width: 768px) {
  #map {
    height: 400px;
  }
}
</style>
</head>
<body>

<div class="container">
  <div id="map"></div>
  <div class="info">
    <h2>Info do concelho</h2>
    <div id="infoContent">
      Clique num concelho para gerar um PDF com o nome do concelho.
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

// Inicializar mapa
const map = L.map('map', { zoomControl: true, attributionControl: false })
  .setView([39.5, -8], 7);

// Armazenar todos os concelhos
let concelhosMap = {};

// Função para carregar todos os concelhos via API
async function loadAllConcelhos() {
  let offset = 0;
  const limit = 100;
  let totalRecords = 1; // inicializamos >0 para entrar no loop

  while(offset < totalRecords) {
    const url = `https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-portugal-concelho/records?limit=${limit}&offset=${offset}`;
    const res = await fetch(url);
    const data = await res.json();

    if(!data.records) break;

    data.records.forEach(r => {
      const fields = r.record?.fields;
      if(fields && fields.codigo != null){
        concelhosMap[fields.codigo] = fields;
      }
    });

    totalRecords = data.nhits;
    offset += limit;
  }

  console.log('Todos concelhos carregados:', Object.keys(concelhosMap).length);
}

// Função para carregar o GeoJSON dos concelhos e adicionar ao mapa
async function loadGeoJSON() {
  const res = await fetch('concelhos.json'); // teu GeoJSON local
  const geoData = await res.json();

  geoData.geometries.forEach(geom => {
    const codigo = geom.properties?.codigo || Math.floor(Math.random()*10000);
    const feature = {
      type: "Feature",
      properties: { codigo: codigo, name: `Concelho ${codigo}` },
      geometry: geom
    };

    L.geoJSON(feature, {
      style: () => ({
        color: '#556',
        weight: 1,
        fillColor: '#ccc',
        fillOpacity: 0.6
      }),
      onEachFeature: (feature, layer) => {
        layer.on('click', () => {
          const info = concelhosMap[feature.properties.codigo];
          if(info){
            const content = `
              <strong>Nome Concelho:</strong> ${info.nome}<br>
              <strong>Distrito:</strong> ${info.distrito}<br>
              <strong>Código:</strong> ${info.codigo}<br>
              <strong>Ano:</strong> ${info.ano}<br>
              <strong>Tipo:</strong> ${info.tipo}
            `;
            document.getElementById('infoContent').innerHTML = content;

            const doc = new jsPDF();
            doc.setFontSize(22);
            doc.text(`Documento do concelho de ${info.nome}`, 20, 30);
            doc.setFontSize(14);
            doc.text(`Distrito: ${info.distrito}`, 20, 50);
            doc.text(`Código: ${info.codigo}`, 20, 60);
            doc.text(`Ano: ${info.ano}`, 20, 70);
            doc.text(`Tipo: ${info.tipo}`, 20, 80);
            doc.save(`Concelho_${info.nome}.pdf`);
          } else {
            alert('Info não encontrada para este concelho.');
          }
        });

        layer.on('mouseover', () => layer.setStyle({ fillColor: '#faa', weight: 2 }));
        layer.on('mouseout', () => layer.setStyle({ fillColor: '#ccc', weight: 1 }));
      }
    }).addTo(map);
  });
}

// Carregar API e GeoJSON
loadAllConcelhos().then(() => {
  loadGeoJSON();
});
</script>
</body>
</html>
