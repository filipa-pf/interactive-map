<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Portugal</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { margin:0; font-family: sans-serif; }
#container { display:flex; gap:10px; padding:10px; }
#map { flex:2 1 600px; min-width:300px; height:600px; }
#info { flex:1 1 200px; border:1px solid #ccc; padding:10px; height:600px; overflow:auto; }
</style>
</head>
<body>

<div id="container">
  <div id="map"></div>
  <div id="info"><strong>Info do concelho</strong></div>
</div>

<script>
const coresDistritos = {
  'Aveiro':'#fbb4ae', 'Beja':'#b3cde3', 'Braga':'#ccebc5','Bragança':'#decbe4',
  'Castelo Branco':'#fed9a6','Coimbra':'#ffffcc','Évora':'#e5d8bd','Faro':'#fddaec',
  'Guarda':'#f2f2f2','Leiria':'#fb8072','Lisboa':'#80b1d3','Portalegre':'#fdb462',
  'Porto':'#b3de69','Santarém':'#fccde5','Setúbal':'#d9d9d9','Viana do Castelo':'#bc80bd',
  'Vila Real':'#ccebc5','Viseu':'#ffed6f','Madeira':'#8dd3c7','Açores':'#ffffb3'
};

function escurecerCor(cor){
  // simples ajuste de luminosidade
  const num = parseInt(cor.replace('#',''),16);
  const r = Math.max((num >> 16 & 255) - 50,0);
  const g = Math.max((num >> 8 & 255) - 50,0);
  const b = Math.max((num & 255) - 50,0);
  return `rgb(${r},${g},${b})`;
}

// transforma coordenadas das ilhas para miniaturas
function transformarIlha(coords, scale, offset){
  return coords.map(ring => ring.map(([x,y]) => [x*scale + offset[0], y*scale + offset[1]]));
}

const map = L.map('map', { zoomControl:false, attributionControl:false }).setView([39.5,-8],7);
const ilhasLayer = L.layerGroup().addTo(map);

async function loadConcelhos(){
  try {
    const res = await fetch('https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-portugal-concelho/exports/json');
    const data = await res.json();

    const continente = [];

    data.forEach(d=>{
      const feature = d.geo_shape;
      feature.properties = { con_name:d.con_name, dis_name:d.dis_name };

      if(['Açores','Madeira'].includes(d.dis_name)){
        // miniaturas
        const coords = transformarIlha(feature.coordinates, 0.25, d.dis_name==='Açores'? [7,-2] : [8,-3]);
        L.geoJSON({ ...feature, coordinates: coords }, { 
          style:{ color:'#000', fillColor:coresDistritos[d.dis_name], fillOpacity:0.6 } 
        }).addTo(ilhasLayer);
      } else {
        continente.push(feature);
      }
    });

    const continenteLayer = L.geoJSON(continente, {
      style: f=>({ color:'#000', fillColor: coresDistritos[f.properties.dis_name], fillOpacity:0.6 }),
      onEachFeature: (feature, layer)=>{
        const nome = feature.properties.con_name;
        const distrito = feature.properties.dis_name;
        const corOriginal = coresDistritos[distrito];

        layer.on('mouseover',()=> layer.setStyle({ fillColor: escurecerCor(corOriginal) }));
        layer.on('mouseout',()=> layer.setStyle({ fillColor: corOriginal }));
        layer.on('click',()=>{
          document.getElementById('info').innerHTML = `
            <strong>${nome}</strong><br>
            Distrito: ${distrito}<br>
            <button id="pdfBtn">Gerar PDF</button>
          `;
          document.getElementById('pdfBtn').onclick = ()=>{
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Concelho: ${nome}\nDistrito: ${distrito}`,10,10);
            doc.save(`${nome}.pdf`);
          };
        });
      }
    }).addTo(map);

    map.fitBounds(continenteLayer.getBounds(), { padding:[20,20], maxZoom:10 });

  } catch(err){
    console.error('Erro ao carregar concelhos:', err);
  }
}

loadConcelhos();
</script>

</body>
</html>
